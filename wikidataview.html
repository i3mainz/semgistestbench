<html>
<head><title>Wikidata View</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/osmtogeojson@2.2.12/osmtogeojson.js"></script>
  <script src="js/leaflet.polylinedecorator.js"></script>
     <script src="js/leaflet.fullscreen.js"></script>
   <script src="js/leaflet_legend.js"></script>
      <script src="js/leaflet_easyprint.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  
<script>

function getWikidataItemsInView(){
        //overpass query
}

function buildOverpassApiUrl(map, overpassQuery) {
        var bounds = map.getBounds().getSouth() + ',' + map.getBounds().getWest() + ',' + map.getBounds().getNorth() + ',' + map.getBounds().getEast();
        var nodeQuery = 'node[' + overpassQuery + '](' + bounds + ');';
        var wayQuery = 'way[' + overpassQuery + '](' + bounds + ');';
        var relationQuery = 'relation[' + overpassQuery + '](' + bounds + ');';
        var query = '?data=[out:json][timeout:15];(' + nodeQuery + wayQuery + relationQuery + ');out geom;';
        var baseUrl = 'https://overpass-api.de/api/interpreter';
        var resultUrl = baseUrl + query;
        return resultUrl;
}

function getOSMAttributesForCoordinate(map){
$.get(buildOverpassApiUrl(map,"wikidata"), function (osmDataAsJson) {
          var resultAsGeojson = osmtogeojson(osmDataAsJson);
          var resultLayer = L.geoJson(resultAsGeojson, {
            style: function (feature) {
              return {color: "#ff0000"};
            },
            filter: function (feature, layer) {
              var isPolygon = (feature.geometry) && (feature.geometry.type !== undefined) && (feature.geometry.type === "Polygon");
              if (isPolygon) {
                feature.geometry.type = "Point";
                var polygonCenter = L.latLngBounds(feature.geometry.coordinates[0]).getCenter();
                feature.geometry.coordinates = [ polygonCenter.lat, polygonCenter.lng ];
              }
              return true;
            },
            onEachFeature: function (feature, layer) {
              var popupContent = "";
              popupContent = popupContent + "<b>" + feature.properties.type + "/" + feature.properties.id + "</b>";
              popupContent+="<br/>OSM Attributes:<ul>"
              wdkeyset={}
              console.log("Wikidata: "+feature.properties.tags["wikidata"])
              if(feature.properties.tags["wikidata"]!="" && feature.properties.tags["wikidata"]!=undefined){
                    wdkeyset=getAttributesForWikidataID(feature.properties.tags["wikidata"])
             }
              var keys = Object.keys(feature.properties.tags);
              keys.forEach(function (key) {
              var ignorekeys=[]
                popupContent = popupContent + "<li>"
                                console.log("Key: "+key+" - "+JSON.stringify(osmToWikidataMap[key]) )
                                console.log(JSON.stringify(wdkeyset))
                if(key in osmToWikidataMap && osmToWikidataMap[key] in wdkeyset){
                        popupContent+="<a style=\"color:green\" href=\""+Object.keys(osmToWikidataMap[key])[0]+"\"  target=\"_blank\">"+key+"</a>"
                        if(wdkeyset[osmToWikidataMap[key]]==feature.properties.tags[key]){
                                popupContent = popupContent + " - <a href=\""+Object.keys(osmToWikidataMap[key])[0]+"\"  target=\"_blank\" style=\"color:green\">" + feature.properties.tags[key] + "</a></li>";
                        }else{
                                popupContent = popupContent + " - <a href=\""+Object.keys(osmToWikidataMap[key])[0]+"\"  target=\"_blank\" style=\"color:orange\">" + feature.properties.tags[key] + " | "+wdkeyset[osmToWikidataMap[key]]+"</a></li>";
                        }
                }else if(key in osmToWikidataMap){
                        popupContent+="<a style=\"color:orange\" href=\""+Object.keys(osmToWikidataMap[key])[0]+"\" target=\"_blank\">"+key+"</a>"
                         popupContent = popupContent + " - " + feature.properties.tags[key] + "</li>";
                }else{
                    popupContent+="<span style=\"color:black\">"+key+"</span>"
		    if(feature.properties.tags[key].includes("http")){
			popupContent = popupContent + " - <a href=\""+feature.properties.tags[key]+"\" target=\"_blank\">" + feature.properties.tags[key] + "</a></li>";
		    }else{
			popupContent = popupContent + " - " + feature.properties.tags[key] + "</li>";
		    }
                     
                }
              });
              popupContent = popupContent + "</ul>"
              popupContent+="Wikidata Items: <ul>"
              for(key in wdkeyset){
                        if(!(Object.values(wdkeyset[key])[0].includes("statement"))){
                            spl=Object.values(wdkeyset[key])[0].split(";")
                            if(key in wikidataToOSMMap){
                                    popupContent+="<li><a href=\""+key+"\" target=\"_blank\" style=\"color:orange\">"+Object.keys(wdkeyset[key])[0]+"</a> - "
                            }else{
                                    popupContent+="<li><a href=\""+key+"\" target=\"_blank\">"+Object.keys(wdkeyset[key])[0]+"</a> - "
                            }
			    if(spl[0].includes(".jpg")){
			    	popupContent+="<a href=\""+spl[0]+"\" target=\"_blank\"><img src=\""+spl[1].replace("http","https")+"\" height=\"30\" width=\"30\"></a></li>"
			    }else if(spl[0].includes("http")){
			    	popupContent+="<a href=\""+spl[0]+"\" target=\"_blank\">"+spl[1]+"</a></li>"
			    }else{
			    	popupContent+=spl[1]+"</li>"
			    }
                        }
              }
              popupContent+="</ul>"
              layer.bindPopup(popupContent,{maxWidth : 560});
            }
          }).addTo(map);
        });
        }

function getWikidataAttributesForCoordinate(){
    //wikidataQuery
}

function getAttributesForWikidataID(qid){
var query = [ "PREFIX bd: <http://www.bigdata.com/rdf#>\n",
                "PREFIX wikibase: <http://wikiba.se/ontology#>\n",
                "PREFIX wdt: <http://www.wikidata.org/prop/direct/>\n",
                "PREFIX wd: <http://www.wikidata.org/entity/>\n",
                "PREFIX skos: <http://www.w3.org/2004/02/skos/core#>\n",          
                "SELECT DISTINCT ?rel ?relLabel ?val ?valLabel\n",
                "WHERE\n",
                "{\n",
                "\twd:"+qid+" ?rell ?val .\n",
                "\t?rel wikibase:directClaim ?rell .\n",
                "\tSERVICE wikibase:label { bd:serviceParam wikibase:language \"en\" }\n",
                "}\n",
                "ORDER BY ?relLabel"
    ].join(" ");
    //alert(query)
  var queryUrl = "https://query.wikidata.org/sparql?query="+ encodeURIComponent(query) +"&format=json";
  var res={}
//var queryUrl = encodeURI( "https://query.wikidata.org/sparql?query="+query+"&format=json" );
    $.ajax({
        dataType: "json",  
        url: queryUrl,
        async:false,
        success: function( _data ) {
            console.log(JSON.stringify(_data))
            var results = _data.results.bindings;
             for ( var i in results ) {
                 if(results[i]["rel"]["value"]!=undefined && results[i]["valLabel"]["value"]!=undefined){
                        res[results[i]["rel"]["value"]]=JSON.parse("{\""+results[i]["relLabel"]["value"]+"\":\""+results[i]["val"]["value"]+";"+results[i]["valLabel"]["value"]+"\"}")
                 }
            }
            //alert(JSON.stringify(res))
        }
    });  
    return res;
}

function getMatchingWikiDataOSMAttributes(){
var query = [
"PREFIX bd: <http://www.bigdata.com/rdf#>\n" ,
                "PREFIX wikibase: <http://wikiba.se/ontology#>\n" ,
                "PREFIX wdt: <http://www.wikidata.org/prop/direct/>\n" ,
                "PREFIX wd: <http://www.wikidata.org/entity/>\n" ,
                "SELECT DISTINCT ?wdclass ?wdclassLabel ?osm\n" ,
                "WHERE\n" ,
                "{\n" ,
                "\t?wdclass wdt:P1282 ?osm .\n" ,
                "\tSERVICE wikibase:label { bd:serviceParam wikibase:language \"en\" }\n" ,
                "}\n" ,
                "ORDER BY ?wdclassLabel"
].join(" ");
var queryUrl = "https://query.wikidata.org/sparql?query="+ encodeURIComponent(query) +"&format=json";
//var queryUrl = encodeURI( "https://query.wikidata.org/sparql?query="+query+"&format=json" );
    $.ajax({
        dataType: "json",  
        async: false,
        url: queryUrl,
        success: function( _data ) {
            console.log(JSON.stringify(_data))
            var results = _data.results.bindings;
            for ( var i in results ) {
                
                 if(results[i]["wdclass"]["value"]!=undefined && results[i]["osm"]["value"]!=undefined){
                  osmval=results[i]["osm"]["value"].replace("Key:","")
                 osmToWikidataMap[osmval]=JSON.parse("{\""+results[i]["wdclass"]["value"]+"\":\""+("wdclassLabel" in results[i]?results[i]["wdclassLabel"]["value"]:"")+"\"}")
                    wikidataToOSMMap[results[i]["wdclass"]["value"]]=JSON.parse("{\""+osmval+"\":\""+("wdclassLabel" in results[i]?results[i]["wdclassLabel"]["value"]:"")+"\"}");
                 }
            }
            wikidataToOSMMap["http://www.w3.org/2000/01/rdf-schema#label"]="name"
            osmToWikidataMap["name"]="http://www.w3.org/2000/01/rdf-schema#label"
            console.log(osmToWikidataMap)
            console.log(wikidataToOSMMap)
        }
    });
}


function loadItems(){
    getOSMAttributesForCoordinate(map);
}

</script>

</head>
<body>
<h2 align="center">Wikidata Mapview</h2>

<div id="mapid" style="height:80%">
<script>
var wikidataToOSMMap={}
var osmToWikidataMap={}
	var map = L.map('mapid',{fullscreenControl: true,fullscreenControlOptions: {position: 'topleft'}}).locate({setView: true, maxZoom: 13});//.setView([51.505, -0.09], 13);
        
getMatchingWikiDataOSMAttributes();
        getWikidataAttributesForCoordinate();
      


	var layer = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
			'<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
			'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
		id: 'mapbox.streets'
	}).addTo(map);

</script>
</div>
<button type="button" id="loadbutton" onClick="loadItems()">Load Wikidata Items</button>
</body>
</html>
 
